{{ $img := .img }}
{{ $params := .params }}
{{ $width := (float .img.Width) }}
{{ $height := (float .img.Height) }}
{{ $ratio := div $width $height }}
{{ $origPath := path.Split .img.RelPermalink }}
{{ $resize := false }}
{{ $fill := false }}
{{ $crop := false }}


{{ with .params.preprocess.rotate }}
    {{ if $params.preprocess.flipsides }}
        {{ $tmp := $width }}
        {{ $width = $height }}
        {{ $height = $tmp }}
    {{ end }}
    {{ $args := printf "%dx%d %s" (int (math.Round $width)) (int (math.Round $height)) . }}
    {{ $img = $img.Resize $args }}
    {{ $newpath := path.Join $origPath.Dir (print (path.BaseName $origPath.File) "-" . (path.Ext $img.RelPermalink)) }}    
    {{ $img = $img | resources.Copy (print $newpath) }}
    {{ $origPath = path.Split $img.RelPermalink }}
{{ end }}

{{ with .params.preprocess.ratio }}
    {{ if (ge . $ratio) }}
        {{ $height = div $width . }}
    {{ else }}
        {{ $width = mul . $height }}
    {{ end }}
    {{ $resize = true }}
    {{ $fill = true }}
{{ end }}

{{ with .params.preprocess.zoom }}
    {{ $zoom := (float .) }}
    {{ $height = div $height $zoom }}
    {{ $width = div $width $zoom }}
    {{ $crop = true }}
    {{ $resize = true }}
{{ end }}

{{ $size := printf "%dx%d" (int (math.Round $width)) (int (math.Round $height)) }}
{{ $args := (slice $size) }}
{{ if .params.process.compress }}
    {{ $args = $args | append "webp" }}
    {{ $args = $args | append (printf "q%d" site.Data.hugoModImage.srcset.quality) }}
{{ end }}
{{ with .params.preprocess.anchor }}
    {{ $args = $args | append . }}
{{ end }}

{{ if $resize }}
    {{ if $crop }}
        {{ $img = $img.Crop (print (delimit $args " ")) }}
    {{ else if $fill }}
        {{ $img = $img.Fill (print (delimit $args " ")) }}
    {{ end }}   
    {{ $newpath := path.Join $origPath.Dir (print (path.BaseName $origPath.File) "-" $size (path.Ext $img.RelPermalink )) }}    
    {{ $img = $img | resources.Copy (print $newpath) }}
{{ end }} 

{{ return $img }}