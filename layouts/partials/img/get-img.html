{{- /* Constants */}}
{{- $name := "hugo-mod-image â€“ img/get-img" }}
{{- $configName := "data/hugoModImage" }}
{{- $errorLevel := site.Data.hugoModImage.errorLevel | default "warning" | lower }}
{{- $configErrorEnd := printf " Please check the configuration in %q" $configName }}

{{- /* Arguments */}}
{{- $src := .src }}
{{- $ctx := .ctx }}

{{- if not (in (slice "ignore" "warning" "error") $errorLevel) }}
    {{- $s := print "The errorLevel %q is invalid." $configErrorEnd }}
    {{- errorf $s $errorLevel }}
{{- end }}

{{- $map := "" }}
{{- $url := urls.Parse $src }}
{{- $args := dict "url" $url "ctx" $ctx "errorLevel" $errorLevel }}

{{- with (partialCached "resource/func/get-with-params" $args $args) }}
    {{- if (eq .r.MediaType.MainType "image") }}
        {{- $map = dict "img" .r "params" .params }}
    {{- else }}
        {{- $msg := printf "The resource %q is not or does not contain an image source." $src }}
        {{- partial "md-error-msg" (dict "caller" $name "ctx" $ctx "errorMsg" $msg "errorLevel" $errorLevel) }}
    {{- end }}
{{- end }}

{{- if not $map.img }}
    {{- $map = dict "img" (partial "img/missing" . ) }}
{{- end }}

{{- /* Collect parameters */}}
{{- $params := dict }}
{{- with $map }} 
    {{- /* Params from resource properties or image data */}}
    {{- $params = partial "img/func/params/resource" (dict "img" .img "paramsOld" $params ) }}
    {{- /* Specific params */}}
    {{- $params = partial "img/func/params/extra" (dict "paramsNew" .params "paramsOld" $params) }}
    {{- /* Caption params */}}
    {{- $params = partial "resource/func/caption" (dict "paramsNew" .params "paramsOld" $params) }}
{{- end }}

{{ $map = merge $map (dict "params" $params) }}

{{- return $map }}