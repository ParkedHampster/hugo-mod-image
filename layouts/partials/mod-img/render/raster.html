{{/* 
  Context:
    - img
    - params 
*/ -}}

{{- $img := .img }}
{{- $params := .params }}
{{- $maxLqip := site.Data.modImg.srcset.lqip.max | default 2048 }}


{{- $placeholder := "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" }}

{{- if $params.process.run }}
    {{- if $params.process.base64 }}
        {{- $base64 := partial "mod-img/func/raster/base64" (dict "img" $img "params" $params) }}
        {{- $params = merge $params (dict (slice "imgAttrs" "src") $base64 ) }}
        {{- $params = merge $params (dict (slice "imgAttrs" "loading") "lazy" ) }}
    {{- else }}
        {{- with (partial "mod-img/func/raster/srcset" (dict "img" $img "params" $params) ) }}
            {{- $params = merge $params (dict
                    (slice "imgAttrs" "src") .fallback.RelPermalink
                    (slice "imgAttrs" "width") (string .fallback.Width)
                    (slice "imgAttrs" "height") (string .fallback.Height)
                )
            }}
            {{- with .srcset }}
                {{- $params = merge $params (dict 
                        (slice "imgAttrs" "data-srcset") .
                        (slice "imgAttrs" "data-sizes") "auto"
                    ) }}
            {{- end }}
            {{- if $params.lqip.run | default true }}      
                {{- $lqip := partial "mod-img/func/raster/lqip" (dict "img" .fallback "params" $params) -}}
                {{- $lqipBase64 := printf "data:image/webp;base64,%s" (base64Encode $lqip.Content) }}
                {{- $lsClass := "" }}
                {{- if lt (len $lqipBase64) $maxLqip }}
                    {{- $params = merge $params (dict (slice "imgAttrs" "srcset") $lqipBase64 ) }}
                    {{- $lsClass = printf "%s %s" (site.Data.modImg.lsImgClass | default "img--ls") "img--lqip" }}
                {{- else }}
                    {{- $params = merge $params (dict (slice "imgAttrs" "srcset") $placeholder) }}
                    {{- $params = merge $params (dict (slice "imgAttrs" "data-lowsrc") $lqip.RelPermalink ) }}
                    {{- $lsClass = site.Data.modImg.lsImgClass | default "img--ls" }}                
                {{- end }}
                {{ with $params.imgAttrs.class }}
                    {{- $params = merge $params (dict (slice "imgAttrs" "class") (printf "%s lazyload %s" . $lsClass)) }}
                {{- else }}
                    {{- $params = merge $params (dict (slice "imgAttrs" "class") (printf "lazyload %s" $lsClass)) }}
                {{- end }}
            {{- else }}
                {{- $params = merge $params (dict (slice "imgAttrs" "srcset") $placeholder) }}
            {{- end }}
        {{- end }}
    {{- end }}    
    
{{- else }}
    {{- $params := merge $params (dict (slice "imgAttrs" "src") $img.RelPermalink ) }} 
    {{- $params = merge $params (dict (slice "imgAttrs" "loading") "lazy" ) }}
{{- end }}

{{- if .params.index }}

    {{- $params = merge $params (dict (slice "imgAttrs" "data-pagefind-meta") "image[src], image_alt[alt]" ) }} 
{{- end }}
<img
  {{- range $k, $v := $params.imgAttrs }}
      {{- printf " %s=%q" $k $v | safeHTMLAttr }}
  {{- end -}}
>
{{- /**/ -}}       