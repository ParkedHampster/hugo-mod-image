{{- /* Init */}}
{{- $hookName := "hugo-mod-image – render-image" }}
{{- $configName := "data/hugoModImage" }}
{{- $ctx := . }}
{{- $errorLevel := site.Data.hugoModImage.errorLevel | default "warning" | lower }}
{{- $configErrorEnd := printf " Please check the configuration in %q" $configName }}

{{- $src := .Destination }}
{{- $url := urls.Parse .Destination }}

{{- if not (in (slice "ignore" "warning" "error") $errorLevel) }}
    {{- $s := print "The errorLevel %q is invalid." $configErrorEnd }}
    {{- errorf $s $errorLevel }}
{{- end }}

{{- $img := "" }}
{{- $data := "" }}
{{- $args := dict "url" $url "ctx" $ctx "errorLevel" $errorLevel }}
{{- with (partialCached "resource/func/get" $args $args) }}
    {{- if (in (slice "yaml" "toml" "json") .MediaType.SubType ) }}
        {{- $data = transform.Unmarshal . }}
        {{- $url := urls.Parse $data.src }} 
        {{- $args := dict "url" $url "ctx" $ctx "errorLevel" $errorLevel }}
        {{- with (partialCached "resource/func/get" $args $args) }}
            {{- if (eq .MediaType.MainType "image") }}
                {{- $img = . }}
            {{- else }}
                {{- $msg := printf "The resource %q in %q is not an image." $data.src $src }}
                {{- partial "md-error-msg" (dict "caller" $hookName "ctx" $ctx "errorMsg" $msg "errorLevel" $errorLevel) }}
            {{- end }}
        {{- end }}
    {{- else }}
        {{- if (eq .MediaType.MainType "image") }}
            {{- $img = . }}
        {{- else }}
            {{- $msg := printf "The resource %q is not an image." $src }}
            {{- partial "md-error-msg" (dict "caller" $hookName "ctx" $ctx "errorMsg" $msg "errorLevel" $errorLevel) }}
        {{- end }}
    {{- end }}
{{- end }}

{{- if not $img }} {{- /* Placeholder for missing images */}}
    {{- with resources.Get site.Data.hugoModImage.missing }}
        {{- $img = . }}
    {{- else }}
        {{- $msg := print "Can’t resolve file for missing image" $configErrorEnd }}
        {{- partial "error-msg" (dict "caller" $hookName "errorMsg" $msg "errorLevel" $errorLevel) }}
    {{- end }}
{{- end }}

{{- /* Parameter defaults */}}
{{- $params := dict }}
{{- with site.Data.hugoModImage.id }}
    {{- $params = (dict (slice "attrs" "id") (printf . (add $.Ordinal 1))) }}
{{- else }}
    {{- $msg := print "Can’t find default id." $configErrorEnd }}
    {{- partial "error-msg" (dict "caller" $hookName "errorMsg" $msg "errorLevel" $errorLevel) }}
{{- end }}

{{- if .IsBlock }}
    {{- with site.Data.hugoModImage.default.figure.class.width }} 
        {{- $params = merge $params (dict (slice "class" "width") . ) }} {{- /* Replace with range for more params */}}
    {{- else }}
        {{- $msg := print "Can’t find default width for figure." $configErrorEnd }}
        {{- partial "error-msg" (dict "caller" $hookName "errorMsg" $msg "errorLevel" $errorLevel) }}
    {{- end }}
{{- else }}
    {{- with site.Data.hugoModImage.default.embed.class.width }}
        {{- $params = merge $params (dict (slice "class" "width") . ) }}
    {{- else }}
        {{- $msg := print "Can’t find default width for embedded image." $configErrorEnd }}
        {{- partial "error-msg" (dict "caller" $hookName "errorMsg" $msg "errorLevel" $errorLevel) }}
    {{- end }}
{{- end }}

{{- /* Collect parameters */}}
{{- with $img }} {{- /* Params from resource properties or image data */}}
    {{- $params = partial "img/func/params/resource" (dict "resource" . "paramsOld" $params) }}
{{- end }}

{{- with $img.Params }} {{- /* Extra params in the front-matter resources */}}
    {{- $params = partial "img/func/params/extra" (dict "paramsNew" . "paramsOld" $params) }}
    {{- $params = partial "resource/func/caption" (dict "paramsNew" . "paramsOld" $params) }}
{{- end }}

{{- with $data }} {{- /* Extra params in separate data file */}}
    {{- $params = partial "img/func/params/extra" (dict "paramsNew" . "paramsOld" $params) }}
    {{- $params = partial "resource/func/caption" (dict "paramsNew" . "paramsOld" $params) }}
{{- end }}

{{- with . }} {{- /* Params from the hook */}}
    {{- $params = partial "img/func/params/hook" (dict "ctx" . "paramsOld" $params )}}
{{- end }}

{{- with and (not $url.IsAbs) $url.Query }} {{- /* Params from a query string (only local) */}}
    {{- $params = partial "img/func/params/query" (dict "query" . "paramsOld" $params) }}
{{- end }}

{{ $params = merge $params (dict "attrs" .Attributes) }} {{- /* Params from Markdown attributes */}}

{{- /* Aggregate classes */}}
{{- if .IsBlock }}
    {{- $params = partial "img/func/class/figure" $params }}
{{- else }}
    {{- $params = partial "img/func/class/embed" $params }}
{{- end }}

{{- $args := (dict "img" $img "params" $params )}}
{{- partial "img/container/img" $args }}
{{- /**/ -}}
