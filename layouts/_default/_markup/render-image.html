{{- /* Init */}}
{{- $hookName := "hugo-mod-image – render-image" }}
{{- $configName := "data/hugoModImage" }}
{{- $errorLevel := site.Data.hugoModImage.errorLevel | default "warning" | lower }}
{{- $configErrorEnd := printf " Please check the configuration in %q" $configName }}
{{- if not (in (slice "ignore" "warning" "error") $errorLevel) }}
    {{- $s := print "The errorLevel %q is invalid." $configErrorEnd }}
    {{- errorf $s $errorLevel }}
{{- end }}

{{- /* Variable maps */}}
{{- $ctx := . }}
{{- $url := urls.Parse .Destination }}
{{- $map := dict (slice "img" "src") .Destination }}

{{- /* Parameter defaults */}}
{{- $params := dict }}
{{- with site.Data.hugoModImage.id }}
    {{- $params = (dict (slice "attrs" "id") (printf . (add $.Ordinal 1))) }}
{{- else }}
    {{- $msg := print "Can’t find default id." $configErrorEnd }}
    {{- partial "error-msg" (dict "caller" $hookName "errorMsg" $msg "errorLevel" $errorLevel) }}
{{- end }}

{{- if .IsBlock }}
    {{- with site.Data.hugoModImage.default.figure.class.width }} 
        {{- $params = merge $params (dict "width" . ) }} {{- /* Replace with range for more params */}}
    {{- else }}
        {{- $msg := print "Can’t find default width for figure." $configErrorEnd }}
        {{- partial "error-msg" (dict "caller" $hookName "errorMsg" $msg "errorLevel" $errorLevel) }}
    {{- end }}
{{- else }}
    {{- with site.Data.hugoModImage.default.embed.class.width }}
        {{- $params = merge $params (dict "width" . ) }}
    {{- else }}
        {{- $msg := print "Can’t find default width for embedded image." $configErrorEnd }}
        {{- partial "error-msg" (dict "caller" $hookName "errorMsg" $msg "errorLevel" $errorLevel) }}
    {{- end }}
{{- end }}
{{- $map = merge $map (dict "params" $params ) }}

{{- /* Get, aggregate, and render */}}
{{- $args := dict "map" $map "ctx" $ctx }}
{{- with (partialCached "img/get-img-in-map" $args $args) }}
    {{- /* Collect hook parameters */}}
    {{- $params := partial "img/func/params/hook" (dict "ctx" $ctx "paramsOld" .params ) }}
    {{- with and (not $url.IsAbs) $url.Query }} {{- /* Params from a query string (only local) */}}
        {{- $params = partial "img/func/params/query" (dict "query" . "paramsOld" $params) }}
    {{- end }}
    {{ $params = merge $params (dict "attrs" $ctx.Attributes) }} {{- /* Params from Markdown attributes */}}

    {{- /* Aggregate classes */}}
    {{- $params = partial "img/func/container" $params }}
    {{- if $.IsBlock }}
        {{- $params = partial "img/func/class" (dict "type" "figure" "params" $params ) }}
    {{- else }}
        {{- $params = partial "img/func/class" (dict "type" "embed" "params" $params ) }}
    {{- end }}

    {{- /* Render */}}
    {{- partial "img/debug" $params }}
    {{- $args := (dict "img" .img "params" $params )}}
    {{- if $.IsBlock }}
        {{- partial "img/render/container/figure" $args }}
    {{- else }}
        {{- partial "img/render/container/embed" $args }}
    {{- end }}
{{- end }}
{{- /**/ -}}
