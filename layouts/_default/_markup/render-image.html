{{- /* Init */}}
{{- $hookName := "image" }}
{{- $configName := "hugoModImage" }}
{{- $src := .Destination }}
{{- $page := .Page }}
{{- $errorLevel := site.Data.hugoModImage.errorLevel | default "warning" | lower }}
{{- $configErrorStart := "The %q hook is misconfigured." }}
{{- $configErrorEnd := "Please check the configuration file %q in the %q folder." }}

{{- if not (in (slice "ignore" "warning" "error") $errorLevel) }}
    {{- $s := print $configErrorStart "The errorLevel %q is invalid." $configErrorEnd }}
    {{- errorf $s $hookName $errorLevel $configName "data" }}
{{- end }}





{{- /* Determine content path for warning and error messages. */}}
{{- $path := "" }}
{{- with .Page.File }}
    {{- $path = .Path }}
{{- else }}
    {{- $path = .Path }}
{{- end }}

{{- $r := "" }}
{{- $data := "" }}
{{- with (partial "func/get-resource.html" (dict "src" $src "page" $page "path" $path "errorLevel" $errorLevel)) }}
    {{- if (in (slice "yaml" "toml" "json") .MediaType.SubType ) }}
        {{- $data = transform.Unmarshal . }}
        {{- with (partial "func/get-resource.html" (dict "src" $data.src "page" $page "path" $path "errorLevel" $errorLevel))}}
            {{- if (eq .MediaType.MainType "image") }}
                {{- $r = . }}
            {{- else }}
                {{- $errorMsg := printf "The %q hook can’t use %q from %q in %q." $hookName $data.src $src $path }}
                {{- partial "img/error-message" (dict "errorMsg" $errorMsg "errorLevel" $errorLevel) }}
            {{- end }}
        {{- end }}
    {{- else }}
        {{- if (eq .MediaType.MainType "image") }}
            {{- $r = . }}
        {{- else }}
            {{- $errorMsg := printf "The %q hook can’t use %q in %q." $hookName $src $path }}
            {{- partial "img/error-message" (dict "errorMsg" $errorMsg "errorLevel" $errorLevel) }}
        {{- end }}
    {{- end }}
{{- end }}

{{- if not $r }} 
    {{- /* Placeholder for missing images */}}
    {{- with resources.Get site.Data.hugoModImage.missing }}
        {{- $r = . }}
    {{- else }}
        {{- $s := print $configErrorStart "The missing image file is invalid." $configErrorEnd }}
        {{- $errorMsg := printf $s $hookName $configName "data" }}
        {{- partial "img/error-message" (dict "errorMsg" $errorMsg "errorLevel" $errorLevel) }}
    {{- end }}
{{- end }}



{{- $attrs := merge .Attributes (dict "alt" .PlainText "title" .Title "src" $r.RelPermalink) }}
{{- if not (eq $r.MediaType.SubType "svg") }}
    {{- $attrs = merge $attrs (dict "height" (string $r.Height) "width" (string $r.Width)) }}
{{- end }}

<img
  {{- range $k, $v := $attrs }}
    {{- if or $v (eq $k "alt") }}
      {{- printf " %s=%q" $k $v | safeHTMLAttr }}
    {{- end }}
  {{- end -}}
>


{{- /**/ -}}


{{- /* 
    Check the .Destination of the image:  
    1. Remote (URL)
    1. Local (page bundle)
    2. Global (assets)
    4. Data file with one of the first three options for the path and additional meta-data
*/ -}}



{{- /* 
    Get the image:
    For the first three options Hugo offers 
*/ -}}